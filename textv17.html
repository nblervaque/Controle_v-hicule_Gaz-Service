<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi V√©hicules - Gaz Service</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 3px solid #ecf0f1;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 5px;
            margin-bottom: 5px;
            border-radius: 8px 8px 0 0;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item.checked {
            background: #d4edda;
            border-color: #28a745;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .state-group {
            margin: 20px 0;
        }

        .state-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .state-item {
            display: flex;
            flex-direction: column;
        }

        .state-item select {
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: white;
            min-height: 48px;
        }

        .state-item select:focus {
            outline: none;
            border-color: #3498db;
        }

        .state-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .controls-list {
            margin-top: 30px;
        }

        .control-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .control-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .control-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .info-value {
            color: #2c3e50;
            margin-top: 2px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-missing {
            background: #f8d7da;
            color: #721c24;
        }

        .status-bon {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-moyen {
            background: #fff3cd;
            color: #856404;
        }

        .status-mauvais {
            background: #f8d7da;
            color: #721c24;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
        }

        .backup-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .backup-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .backup-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            overflow: hidden;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            background: #6c757d;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .file-input-label:hover {
            background: #5a6268;
        }

        /* Styles pour le module photo */
        .photo-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #007bff;
        }

        .photo-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .photo-counter {
            font-weight: 600;
            color: #6c757d;
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 20px;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: translateY(-2px);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-delete:hover {
            background: #c0392b;
        }

        /* Modal cam√©ra */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #3498db;
            color: white;
            flex-shrink: 0;
        }

        .camera-header h4 {
            margin: 0;
        }

        .camera-body {
            padding: 15px 20px;
            text-align: center;
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-body video {
            width: 100%;
            max-width: 450px;
            max-height: 60vh;
            border-radius: 8px;
            background: #000;
        }

        .camera-footer {
            padding: 15px 20px;
            text-align: center;
            background: #f8f9fa;
            flex-shrink: 0;
            border-top: 1px solid #dee2e6;
        }

        /* Affichage des photos dans l'historique */
        .control-photos {
            margin-top: 15px;
        }

        .control-photos h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .photo-thumbnail {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .photo-thumbnail:hover {
            transform: scale(1.05);
        }

        /* Modal d'agrandissement des photos */
        .photo-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-viewer-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .photo-viewer-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .photo-viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Styles pour l'export PDF */
        .pdf-filters {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .date-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .pdf-results {
            margin-top: 20px;
        }

        .pdf-control-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-control-info {
            flex: 1;
        }

        .pdf-control-actions {
            display: flex;
            gap: 10px;
        }

        /* Styles sp√©ciaux pour le PDF am√©lior√© */
        .pdf-page {
            width: 297mm; /* A4 paysage */
            min-height: 210mm;
            background: white;
            padding: 20mm;
            margin: 0;
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
            page-break-after: always;
        }

        .pdf-page:last-child {
            page-break-after: auto;
        }

        .pdf-document-header {
            text-align: center;
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .pdf-company-logo {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .pdf-document-title {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .pdf-subtitle {
            font-size: 12px;
            color: #6c757d;
        }

        .pdf-vehicle-info {
            background: #f8f9fa;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .pdf-vehicle-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .pdf-control-date {
            font-size: 14px;
            color: #6c757d;
        }

        .pdf-sections-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .pdf-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .pdf-section-title {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
        }

        .pdf-items-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .pdf-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dotted #ddd;
        }

        .pdf-item:last-child {
            border-bottom: none;
        }

        .pdf-label {
            font-weight: 600;
            color: #495057;
            font-size: 11px;
        }

        .pdf-value {
            color: #2c3e50;
            font-size: 11px;
        }

        .pdf-status {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .pdf-comments-section {
            grid-column: 1 / -1;
            margin-top: 10px;
        }

        .pdf-comments-content {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 80px;
            overflow: hidden;
        }

        .pdf-photos-section {
            margin-top: 20px;
            page-break-inside: avoid;
        }

        .pdf-photos-title {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
        }

        .pdf-photos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .pdf-photo-container {
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .pdf-photo {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .pdf-photo-caption {
            font-size: 10px;
            color: #6c757d;
            margin-top: 5px;
        }

        .pdf-footer {
            position: absolute;
            bottom: 15mm;
            left: 20mm;
            right: 20mm;
            text-align: center;
            font-size: 10px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
        }

        .pdf-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .pdf-info-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .pdf-info-label {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .pdf-info-value {
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
        }

        /* Styles pour le module de suivi d'avancement */
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid transparent;
        }

        .stat-card.total {
            border-left-color: #3498db;
        }

        .stat-card.done {
            border-left-color: #27ae60;
        }

        .stat-card.pending {
            border-left-color: #e74c3c;
        }

        .stat-card.percent {
            border-left-color: #f39c12;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }

        .vehicle-list {
            margin-top: 20px;
        }

        .vehicle-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .vehicle-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .vehicle-item.checked {
            background: #d4edda;
            border-color: #28a745;
        }

        .vehicle-item.pending {
            background: #fff5f5;
            border-color: #dc3545;
        }

        .vehicle-info {
            flex: 1;
        }

        .vehicle-immat {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .vehicle-details {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .vehicle-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .status-icon.done {
            background: #28a745;
        }

        .status-icon.pending {
            background: #dc3545;
        }

        .last-control-date {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .import-section {
            background: #f8f9fa;
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .import-section.drag-over {
            border-color: #28a745;
            background: #f0fff4;
        }

        .import-instructions {
            color: #6c757d;
            margin-bottom: 20px;
        }

        .import-instructions h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .import-template {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            text-align: left;
        }

        .template-row {
            padding: 3px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .template-header {
            font-weight: bold;
            background: #f8f9fa;
            padding: 5px;
            margin: -5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .main-content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin-right: 0;
                border-radius: 8px;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .control-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }

            .backup-controls {
                grid-template-columns: 1fr;
            }

            .photo-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .photo-preview {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .camera-content {
                width: 95%;
                margin: 10px;
            }

            .camera-header {
                padding: 15px;
            }

            .camera-body {
                padding: 15px;
            }

            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .photo-thumbnail {
                height: 60px;
            }

            .date-filters {
                grid-template-columns: 1fr;
            }

            .pdf-control-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .pdf-control-actions {
                justify-content: center;
            }

            .progress-stats {
                grid-template-columns: 1fr 1fr;
            }

            .vehicle-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .vehicle-status {
                justify-content: space-between;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }

        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #bee5eb;
        }

        /* Masquer les √©l√©ments lors de la g√©n√©ration PDF */
        .pdf-hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Suivi des V√©hicules</h1>
            <p>Gaz Service - Contr√¥le et maintenance</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('nouveau')">Nouveau Contr√¥le</button>
                <button class="tab" onclick="showTab('historique')">Historique</button>
                <button class="tab" onclick="showTab('avancement')">Suivi Avancement</button>
                <button class="tab" onclick="showTab('sauvegarde')">Sauvegarde</button>
                <button class="tab" onclick="showTab('export')">Export Excel</button>
                <button class="tab" onclick="showTab('pdf')">Export PDF</button>
            </div>

            <!-- Onglet Nouveau Contr√¥le -->
            <div id="nouveau" class="tab-content active">
                <form id="vehicleForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="conducteur">Nom du conducteur *</label>
                            <input type="text" id="conducteur" name="conducteur" required>
                        </div>
                        <div class="form-group">
                            <label for="dateControle">Date du contr√¥le *</label>
                            <input type="date" id="dateControle" name="dateControle" required>
                        </div>
                        <div class="form-group">
                            <label for="immatriculation">Immatriculation *</label>
                            <input type="text" id="immatriculation" name="immatriculation" placeholder="XX-XXX-XX" required>
                        </div>
                        <div class="form-group">
                            <label for="kilometrage">Kilom√©trage</label>
                            <input type="number" id="kilometrage" name="kilometrage" placeholder="123456">
                        </div>
                        <div class="form-group">
                            <label for="prochainControle">Prochain contr√¥le technique</label>
                            <input type="date" id="prochainControle" name="prochainControle">
                        </div>
                        <div class="form-group">
                            <label for="derniereRevision">Derni√®re r√©vision (km)</label>
                            <input type="number" id="derniereRevision" name="derniereRevision" placeholder="ex: 120000">
                        </div>
                        <div class="form-group">
                            <label for="commentaires">üí¨ Commentaires et observations</label>
                            <textarea id="commentaires" name="commentaires" rows="3" placeholder="Ajoutez vos observations, remarques ou notes concernant ce contr√¥le..."></textarea>
                        </div>
                    </div>

                    <h3>üìã Documents obligatoires</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="permis" name="permis">
                            <label for="permis">Permis de conduire</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteVerte" name="carteVerte">
                            <label for="carteVerte">Carte verte (assurance)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteGrise" name="carteGrise">
                            <label for="carteGrise">Carte grise</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteCarburant" name="carteCarburant">
                            <label for="carteCarburant">Carte carburant</label>
                        </div>
                    </div>

                    <h3>üõ°Ô∏è √âquipements de s√©curit√©</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="giletJaune" name="giletJaune">
                            <label for="giletJaune">Gilet jaune</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triangle" name="triangle">
                            <label for="triangle">Triangle de signalisation</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="roueSecours" name="roueSecours">
                            <label for="roueSecours">Roue de secours</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="trousseSecours" name="trousseSecours">
                            <label for="trousseSecours">Trousse de secours</label>
                        </div>
                    </div>

                    <h3>üîß √âtat g√©n√©ral</h3>
                    <div class="state-group">
                        <div class="state-grid">
                            <div class="state-item">
                                <label>Rangement du v√©hicule</label>
                                <select name="etatRangement">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Propret√© int√©rieur</label>
                                <select name="propret√©Interieur">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Propret√© ext√©rieur</label>
                                <select name="propret√©Exterieur">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h3>üõû √âtat des pneus</h3>
                    <div class="state-group">
                        <div class="state-grid">
                            <div class="state-item">
                                <label>Pneu avant gauche</label>
                                <select name="pneuAvantGauche">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu avant droit</label>
                                <select name="pneuAvantDroit">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu arri√®re gauche</label>
                                <select name="pneuArriereGauche">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu arri√®re droit</label>
                                <select name="pneuArriereDroit">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h3>üì∏ Photos du contr√¥le</h3>
                    <div class="photo-section">
                        <p style="color: #6c757d; margin-bottom: 15px;">
                            Prenez jusqu'√† 5 photos pour documenter l'√©tat du v√©hicule
                        </p>
                        
                        <div class="photo-controls">
                            <button type="button" class="btn btn-info" onclick="openCamera()" id="cameraBtn">
                                üì± Prendre une photo
                            </button>
                            <span id="photoCount" class="photo-counter">0/5 photos</span>
                        </div>

                        <div id="photoPreview" class="photo-preview">
                            <!-- Photos will be displayed here -->
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">üíæ Enregistrer le contr√¥le</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
                    </div>
                </form>
            </div>

            <!-- Onglet Historique -->
            <div id="historique" class="tab-content">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="üîç Rechercher par immatriculation, conducteur..." onkeyup="filterControls()">
                </div>
                <div id="controlsList" class="controls-list">
                    <div class="no-data">
                        <h3>Aucun contr√¥le enregistr√©</h3>
                        <p>Commencez par ajouter un nouveau contr√¥le</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Suivi Avancement -->
            <div id="avancement" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üìä Suivi d'avancement des contr√¥les</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Importez votre liste de v√©hicules et suivez l'avancement des contr√¥les effectu√©s.
                    </p>

                    <!-- Import de fichier Excel -->
                    <div class="import-section" id="importSection">
                        <div class="import-instructions">
                            <h4>üìã Importation de la liste des v√©hicules</h4>
                            <p>Glissez-d√©posez votre fichier Excel (.xlsx) ou cliquez pour le s√©lectionner</p>
                            <div class="import-template">
                                <div class="template-row template-header">Format attendu du fichier Excel :</div>
                                <div class="template-row">Colonne A : Immatriculation (ex: AB-123-CD)</div>
                                <div class="template-row">Colonne B : Marque (ex: Peugeot)</div>
                                <div class="template-row">Colonne C : Mod√®le (ex: 308)</div>
                            </div>
                        </div>
                        
                        <div class="file-input-wrapper">
                            <input type="file" id="vehicleListFile" accept=".xlsx,.xls" onchange="handleVehicleListFile(this)">
                            <label for="vehicleListFile" class="file-input-label">
                                üìÇ S√©lectionner le fichier Excel
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="importVehicleList()" id="importBtn" disabled>
                                ‚¨ÜÔ∏è Importer la liste
                            </button>
                            <button class="btn btn-danger" onclick="clearVehicleList()">
                                üóëÔ∏è Vider la liste
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques d'avancement -->
                    <div class="progress-stats" id="progressStats" style="display: none;">
                        <div class="stat-card total">
                            <div class="stat-number" id="totalVehicles">0</div>
                            <div class="stat-label">Total v√©hicules</div>
                        </div>
                        <div class="stat-card done">
                            <div class="stat-number" id="controlledVehicles">0</div>
                            <div class="stat-label">Contr√¥l√©s</div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-number" id="pendingVehicles">0</div>
                            <div class="stat-label">En attente</div>
                        </div>
                        <div class="stat-card percent">
                            <div class="stat-number" id="completionPercent">0%</div>
                            <div class="stat-label">Avancement</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Liste des v√©hicules -->
                    <div id="vehicleListContainer" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4>üöó Liste des v√©hicules</h4>
                            <button class="btn btn-success" onclick="exportProgressToExcel()">
                                üìä Exporter le suivi
                            </button>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" id="vehicleSearchInput" placeholder="üîç Rechercher un v√©hicule..." onkeyup="filterVehicleList()">
                        </div>
                        
                        <div id="vehicleList" class="vehicle-list">
                            <!-- Liste des v√©hicules sera g√©n√©r√©e ici -->
                        </div>
                    </div>

                    <div id="progressStatus"></div>
                </div>
            </div>

            <!-- Onglet Sauvegarde -->
            <div id="sauvegarde" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üíæ Gestion des sauvegardes</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Prot√©gez vos donn√©es en cr√©ant des sauvegardes r√©guli√®res. Ces fichiers peuvent √™tre sauvegard√©s dans C:\Users\Public ou tout autre emplacement de votre choix.
                    </p>

                    <!-- Sauvegarde automatique -->
                    <div class="backup-section">
                        <h4>üîÑ Sauvegarde automatique</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            Une sauvegarde automatique est cr√©√©e √† chaque modification des donn√©es.
                        </p>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-info" onclick="downloadAutoBackup()">
                                    üìã T√©l√©charger la sauvegarde auto
                                </button>
                            </div>
                            <div id="autoBackupStatus"></div>
                        </div>
                    </div>

                    <!-- Sauvegarde manuelle -->
                    <div class="backup-section">
                        <h4>üíæ Sauvegarde manuelle</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            Cr√©ez une sauvegarde compl√®te de toutes vos donn√©es.
                        </p>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-success" onclick="createManualBackup()">
                                    üíæ Cr√©er une sauvegarde
                                </button>
                            </div>
                            <div id="manualBackupStatus"></div>
                        </div>
                    </div>

                    <!-- Restauration -->
                    <div class="backup-section">
                        <h4>üìÇ Restaurer une sauvegarde</h4>
                        <div class="warning-message" style="margin-bottom: 15px;">
                            ‚ö†Ô∏è Attention : La restauration effacera toutes les donn√©es actuelles et les remplacera par celles du fichier de sauvegarde.
                        </div>
                        <div class="backup-controls">
                            <div class="file-input-wrapper">
                                <input type="file" id="backupFile" accept=".json" onchange="handleBackupFile(this)">
                                <label for="backupFile" class="file-input-label">
                                    üìÅ S√©lectionner un fichier de sauvegarde
                                </label>
                            </div>
                            <div>
                                <button class="btn btn-warning" onclick="restoreBackup()" id="restoreBtn" disabled>
                                    üîÑ Restaurer la sauvegarde
                                </button>
                            </div>
                        </div>
                        <div id="restoreStatus"></div>
                    </div>

                    <!-- Informations -->
                    <div class="info-message">
                        <h5>üí° Conseils pour la sauvegarde :</h5>
                        <ul style="margin: 10px 0 0 20px;">
                            <li>Effectuez des sauvegardes r√©guli√®res (quotidiennes ou hebdomadaires)</li>
                            <li>Conservez plusieurs copies de sauvegarde √† diff√©rents endroits</li>
                            <li>Testez vos sauvegardes en les restaurant sur un autre appareil</li>
                            <li>Les fichiers de sauvegarde sont au format JSON et contiennent toutes vos donn√©es</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Onglet Export -->
            <div id="export" class="tab-content">
                <div style="text-align: center; padding: 40px;">
                    <h3>üìä Exporter les donn√©es</h3>
                    <p style="margin: 20px 0;">T√©l√©chargez tous les contr√¥les au format Excel (XLSX)</p>
                    <div class="loading" id="exportLoading">
                        <div class="spinner"></div>
                        <p>G√©n√©ration du fichier Excel...</p>
                    </div>
                    <button class="btn btn-success" onclick="exportToExcel()">üì• T√©l√©charger Excel</button>
                    <div id="exportStatus"></div>
                </div>
            </div>

            <!-- Onglet Export PDF -->
            <div id="pdf" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üìÑ Export PDF des contr√¥les</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        G√©n√©rez des rapports PDF individuels pour chaque contr√¥le avec filtre par p√©riode.
                        <strong>Format A4 paysage optimis√© avec photos haute qualit√©.</strong>
                    </p>

                    <!-- Filtres -->
                    <div class="pdf-filters">
                        <h4>üìÖ Filtres de p√©riode</h4>
                        <div class="date-filters">
                            <div class="form-group">
                                <label for="pdfDateDebut">Date de d√©but</label>
                                <input type="date" id="pdfDateDebut" name="pdfDateDebut">
                            </div>
                            <div class="form-group">
                                <label for="pdfDateFin">Date de fin</label>
                                <input type="date" id="pdfDateFin" name="pdfDateFin">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button class="btn btn-primary" onclick="filterControlsForPDF()">
                                    üîç Filtrer les contr√¥les
                                </button>
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button class="btn btn-success" onclick="generateAllPDFs()" id="generateAllBtn" disabled>
                                    üìÑ G√©n√©rer tous les PDFs
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- R√©sultats -->
                    <div id="pdfResults" class="pdf-results" style="display: none;">
                        <h4>üìã Contr√¥les trouv√©s</h4>
                        <div id="pdfControlsList"></div>
                    </div>

                    <div class="loading" id="pdfLoading">
                        <div class="spinner"></div>
                        <p>G√©n√©ration du PDF en cours...</p>
                    </div>

                    <div id="pdfStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal (en dehors du formulaire) -->
    <div id="cameraModal" class="camera-modal" style="display: none;">
        <div class="camera-content">
            <div class="camera-header">
                <h4>üì∏ Prendre une photo</h4>
                <button type="button" class="btn btn-danger" onclick="closeCamera()">‚úñ Fermer</button>
            </div>
            <div class="camera-body">
                <video id="cameraVideo" autoplay playsinline></video>
                <canvas id="photoCanvas" style="display: none;"></canvas>
            </div>
            <div class="camera-footer">
                <button type="button" class="btn btn-primary" onclick="takePhoto()">
                    üì∏ Capturer
                </button>
            </div>
        </div>
    </div>

    <script>
        // Gestion de la base de donn√©es IndexedDB
        let db;
        const DB_NAME = 'GazServiceVehicules';
        const DB_VERSION = 2; // Version incr√©ment√©e pour les nouvelles tables
        const STORE_NAME = 'controles';
        const VEHICLE_STORE_NAME = 'vehicules'; // Nouvelle table pour les v√©hicules
        let selectedBackupFile = null;

        // Variables pour la gestion des photos
        let currentPhotos = [];
        let cameraStream = null;
        const MAX_PHOTOS = 5;

        // Variables pour l'export PDF
        let filteredControlsForPDF = [];

        // Variables pour le suivi d'avancement
        let vehicleList = [];
        let selectedVehicleFile = null;

        // Initialisation de la base de donn√©es
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Cr√©er le store des contr√¥les s'il n'existe pas
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        store.createIndex('immatriculation', 'immatriculation', { unique: false });
                        store.createIndex('dateControle', 'dateControle', { unique: false });
                        store.createIndex('conducteur', 'conducteur', { unique: false });
                    }
                    
                    // Cr√©er le store des v√©hicules pour le suivi
                    if (!db.objectStoreNames.contains(VEHICLE_STORE_NAME)) {
                        const vehicleStore = db.createObjectStore(VEHICLE_STORE_NAME, { 
                            keyPath: 'immatriculation'
                        });
                        vehicleStore.createIndex('marque', 'marque', { unique: false });
                        vehicleStore.createIndex('modele', 'modele', { unique: false });
                    }
                };
            });
        }

        // === FONCTIONS DE GESTION DES V√âHICULES POUR LE SUIVI ===

        // Sauvegarder la liste des v√©hicules
        function saveVehicleList(vehicles) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([VEHICLE_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(VEHICLE_STORE_NAME);
                
                // Vider la liste existante
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    let processed = 0;
                    
                    vehicles.forEach(vehicle => {
                        const addRequest = store.add(vehicle);
                        addRequest.onsuccess = () => {
                            processed++;
                            if (processed === vehicles.length) {
                                resolve();
                                createAutoBackup();
                            }
                        };
                        addRequest.onerror = () => reject(addRequest.error);
                    });
                    
                    if (vehicles.length === 0) {
                        resolve();
                    }
                };
                
                clearRequest.onerror = () => reject(clearRequest.error);
            });
        }

        // R√©cup√©rer la liste des v√©hicules
        function getVehicleList() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([VEHICLE_STORE_NAME], 'readonly');
                const store = transaction.objectStore(VEHICLE_STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Vider la liste des v√©hicules
        function clearVehicleListFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([VEHICLE_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(VEHICLE_STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => {
                    resolve();
                    createAutoBackup();
                };
                request.onerror = () => reject(request.error);
            });
        }

        // G√©rer la s√©lection du fichier Excel des v√©hicules
        function handleVehicleListFile(input) {
            const importBtn = document.getElementById('importBtn');
            const statusEl = document.getElementById('progressStatus');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                    statusEl.innerHTML = '<div class="error-message">Veuillez s√©lectionner un fichier Excel (.xlsx ou .xls)</div>';
                    importBtn.disabled = true;
                    return;
                }
                
                selectedVehicleFile = file;
                importBtn.disabled = false;
                statusEl.innerHTML = `<div class="info-message">Fichier s√©lectionn√© : ${file.name}</div>`;
            } else {
                selectedVehicleFile = null;
                importBtn.disabled = true;
                statusEl.innerHTML = '';
            }
        }

        // Importer la liste des v√©hicules depuis Excel
        async function importVehicleList() {
            if (!selectedVehicleFile) {
                return;
            }
            
            const statusEl = document.getElementById('progressStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Lecture du fichier Excel...</div>';
                
                // Lire le fichier Excel
                const arrayBuffer = await readFileAsArrayBuffer(selectedVehicleFile);
                const workbook = XLSX.read(arrayBuffer);
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convertir en JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    throw new Error('Le fichier doit contenir au moins une ligne de donn√©es apr√®s l\'en-t√™te');
                }
                
                // Traiter les donn√©es (ignorer la premi√®re ligne si c'est l'en-t√™te)
                const vehicles = [];
                const startRow = 0; // Commencer √† la premi√®re ligne
                
                for (let i = startRow; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    if (row[0] && row[0].toString().trim()) { // Si l'immatriculation existe
                        const immatriculation = row[0].toString().trim().toUpperCase();
                        const marque = row[1] ? row[1].toString().trim() : '';
                        const modele = row[2] ? row[2].toString().trim() : '';
                        
                        // Valider le format d'immatriculation (format fran√ßais)
                        if (immatriculation.length > 0) {
                            vehicles.push({
                                immatriculation: immatriculation,
                                marque: marque,
                                modele: modele,
                                dateImport: new Date().toISOString()
                            });
                        }
                    }
                }
                
                if (vehicles.length === 0) {
                    throw new Error('Aucun v√©hicule valide trouv√© dans le fichier');
                }
                
                // Sauvegarder dans la base de donn√©es
                await saveVehicleList(vehicles);
                
                // Actualiser l'affichage
                await loadVehicleProgress();
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ ${vehicles.length} v√©hicule(s) import√©(s) avec succ√®s !</div>`;
                
                // R√©initialiser la s√©lection
                document.getElementById('vehicleListFile').value = '';
                document.getElementById('importBtn').disabled = true;
                selectedVehicleFile = null;
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">‚ùå Erreur lors de l'importation : ${error.message}</div>`;
            }
        }

        // Lire un fichier comme ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Charger et afficher le suivi d'avancement
        async function loadVehicleProgress() {
            try {
                const vehicles = await getVehicleList();
                const controls = await getAllControls();
                
                if (vehicles.length === 0) {
                    document.getElementById('progressStats').style.display = 'none';
                    document.getElementById('vehicleListContainer').style.display = 'none';
                    return;
                }
                
                // Calculer les statistiques
                const totalVehicles = vehicles.length;
                let controlledCount = 0;
                
                // Cr√©er un map des contr√¥les par immatriculation (prendre le plus r√©cent)
                const controlMap = new Map();
                controls.forEach(control => {
                    const immat = control.immatriculation;
                    if (!controlMap.has(immat) || new Date(control.dateControle) > new Date(controlMap.get(immat).dateControle)) {
                        controlMap.set(immat, control);
                    }
                });
                
                // V√©rifier chaque v√©hicule
                const vehicleProgress = vehicles.map(vehicle => {
                    const control = controlMap.get(vehicle.immatriculation);
                    const isControlled = !!control;
                    
                    if (isControlled) {
                        controlledCount++;
                    }
                    
                    return {
                        ...vehicle,
                        isControlled: isControlled,
                        lastControl: control || null
                    };
                });
                
                const pendingCount = totalVehicles - controlledCount;
                const completionPercent = totalVehicles > 0 ? Math.round((controlledCount / totalVehicles) * 100) : 0;
                
                // Mettre √† jour les statistiques
                document.getElementById('totalVehicles').textContent = totalVehicles;
                document.getElementById('controlledVehicles').textContent = controlledCount;
                document.getElementById('pendingVehicles').textContent = pendingCount;
                document.getElementById('completionPercent').textContent = completionPercent + '%';
                document.getElementById('progressFill').style.width = completionPercent + '%';
                
                // Afficher les sections
                document.getElementById('progressStats').style.display = 'grid';
                document.getElementById('vehicleListContainer').style.display = 'block';
                
                // Afficher la liste des v√©hicules
                displayVehicleList(vehicleProgress);
                
                vehicleList = vehicleProgress; // Stocker pour les filtres
                
            } catch (error) {
                console.error('Erreur lors du chargement du suivi d\'avancement:', error);
            }
        }

        // Afficher la liste des v√©hicules avec leur statut
        function displayVehicleList(vehicles) {
            const container = document.getElementById('vehicleList');
            
            if (vehicles.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Aucun v√©hicule dans la liste</h3>
                        <p>Importez un fichier Excel pour commencer le suivi</p>
                    </div>
                `;
                return;
            }
            
            // Trier par statut (non contr√¥l√©s en premier) puis par immatriculation
            vehicles.sort((a, b) => {
                if (a.isControlled !== b.isControlled) {
                    return a.isControlled ? 1 : -1;
                }
                return a.immatriculation.localeCompare(b.immatriculation);
            });
            
            container.innerHTML = vehicles.map(vehicle => {
                const statusClass = vehicle.isControlled ? 'checked' : 'pending';
                const statusIcon = vehicle.isControlled ? '‚úì' : '!';
                const statusText = vehicle.isControlled ? 'Contr√¥l√©' : 'En attente';
                const lastControlDate = vehicle.lastControl ? 
                    new Date(vehicle.lastControl.dateControle).toLocaleDateString('fr-FR') : 
                    'Aucun contr√¥le';
                
                return `
                    <div class="vehicle-item ${statusClass}">
                        <div class="vehicle-info">
                            <div class="vehicle-immat">${vehicle.immatriculation}</div>
                            <div class="vehicle-details">
                                ${vehicle.marque} ${vehicle.modele}
                                ${vehicle.lastControl ? ` - Conducteur: ${vehicle.lastControl.conducteur}` : ''}
                            </div>
                            <div class="last-control-date">Dernier contr√¥le: ${lastControlDate}</div>
                        </div>
                        <div class="vehicle-status">
                            <div class="status-icon ${vehicle.isControlled ? 'done' : 'pending'}">${statusIcon}</div>
                            <span>${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filtrer la liste des v√©hicules
        function filterVehicleList() {
            const searchTerm = document.getElementById('vehicleSearchInput').value.toLowerCase();
            const vehicleItems = document.querySelectorAll('.vehicle-item');
            
            vehicleItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        // Vider la liste des v√©hicules
        async function clearVehicleList() {
            if (confirm('√ätes-vous s√ªr de vouloir vider la liste des v√©hicules ?')) {
                try {
                    await clearVehicleListFromDB();
                    await loadVehicleProgress();
                    showMessage('success', '‚úÖ Liste des v√©hicules vid√©e avec succ√®s');
                } catch (error) {
                    showMessage('error', '‚ùå Erreur lors de la suppression : ' + error.message);
                }
            }
        }

        // Exporter le suivi d'avancement vers Excel
        async function exportProgressToExcel() {
            try {
                const vehicles = await getVehicleList();
                const controls = await getAllControls();
                
                if (vehicles.length === 0) {
                    showMessage('warning', 'Aucune donn√©e √† exporter');
                    return;
                }
                
                // Cr√©er un map des contr√¥les par immatriculation
                const controlMap = new Map();
                controls.forEach(control => {
                    const immat = control.immatriculation;
                    if (!controlMap.has(immat) || new Date(control.dateControle) > new Date(controlMap.get(immat).dateControle)) {
                        controlMap.set(immat, control);
                    }
                });
                
                // Pr√©parer les donn√©es pour Excel
                const excelData = vehicles.map(vehicle => {
                    const control = controlMap.get(vehicle.immatriculation);
                    
                    return {
                        'Immatriculation': vehicle.immatriculation,
                        'Marque': vehicle.marque,
                        'Mod√®le': vehicle.modele,
                        'Statut': control ? 'Contr√¥l√©' : 'En attente',
                        'Date dernier contr√¥le': control ? control.dateControle : '',
                        'Conducteur': control ? control.conducteur : '',
                        'Kilom√©trage': control ? control.kilometrage || '' : '',
                        'Prochain CT': control ? control.prochainControle || '' : '',
                        'Derni√®re r√©vision (km)': control ? control.derniereRevision || '' : '',
                        'Date import v√©hicule': new Date(vehicle.dateImport).toLocaleDateString('fr-FR')
                    };
                });
                
                // Calculer les statistiques pour une feuille de r√©sum√©
                const totalVehicles = vehicles.length;
                const controlledCount = excelData.filter(v => v.Statut === 'Contr√¥l√©').length;
                const pendingCount = totalVehicles - controlledCount;
                const completionPercent = totalVehicles > 0 ? Math.round((controlledCount / totalVehicles) * 100) : 0;
                
                const summaryData = [
                    ['Statistique', 'Valeur'],
                    ['Total v√©hicules', totalVehicles],
                    ['V√©hicules contr√¥l√©s', controlledCount],
                    ['V√©hicules en attente', pendingCount],
                    ['Pourcentage d\'avancement', completionPercent + '%'],
                    ['Date d\'export', new Date().toLocaleDateString('fr-FR')]
                ];
                
                // Cr√©er le workbook avec deux feuilles
                const wb = XLSX.utils.book_new();
                
                // Feuille de r√©sum√©
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'R√©sum√©');
                
                // Feuille d√©taill√©e
                const wsDetail = XLSX.utils.json_to_sheet(excelData);
                
                // Ajuster la largeur des colonnes
                const colWidths = [];
                Object.keys(excelData[0]).forEach(key => {
                    const maxLength = Math.max(
                        key.length,
                        ...excelData.map(row => String(row[key] || '').length)
                    );
                    colWidths.push({ width: Math.min(maxLength + 2, 50) });
                });
                wsDetail['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, wsDetail, 'D√©tail v√©hicules');
                
                // G√©n√©rer et t√©l√©charger le fichier
                const fileName = `Suivi_Avancement_GazService_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage('success', `‚úÖ Fichier "${fileName}" t√©l√©charg√© avec succ√®s !`);
                
            } catch (error) {
                showMessage('error', '‚ùå Erreur lors de l\'export : ' + error.message);
            }
        }

        // === FONCTIONS DE GESTION DES CONTR√îLES (EXISTANTES) ===

        // Sauvegarder un contr√¥le
        function saveControl(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(data);
                
                request.onsuccess = () => {
                    resolve(request.result);
                    // Cr√©er une sauvegarde automatique apr√®s chaque ajout
                    createAutoBackup();
                    // Mettre √† jour le suivi d'avancement si on est sur cet onglet
                    if (document.getElementById('avancement').classList.contains('active')) {
                        loadVehicleProgress();
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        // R√©cup√©rer tous les contr√¥les
        function getAllControls() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Supprimer un contr√¥le
        function deleteControl(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                
                request.onsuccess = () => {
                    resolve();
                    // Cr√©er une sauvegarde automatique apr√®s chaque suppression
                    createAutoBackup();
                    // Mettre √† jour le suivi d'avancement si on est sur cet onglet
                    if (document.getElementById('avancement').classList.contains('active')) {
                        loadVehicleProgress();
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Vider toute la base de donn√©es
        function clearAllData() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // === FONCTIONS DE GESTION DES PHOTOS ===

        // Ouvrir la cam√©ra
        async function openCamera() {
            if (currentPhotos.length >= MAX_PHOTOS) {
                showMessage('warning', `Vous avez d√©j√† atteint la limite de ${MAX_PHOTOS} photos par contr√¥le`);
                return;
            }

            try {
                const modal = document.getElementById('cameraModal');
                const video = document.getElementById('cameraVideo');
                
                // Demander l'acc√®s √† la cam√©ra
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' // Cam√©ra arri√®re par d√©faut
                    } 
                });
                
                video.srcObject = cameraStream;
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('Erreur d\'acc√®s √† la cam√©ra:', error);
                showMessage('error', 'Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions de votre navigateur.');
            }
        }

        // Fermer la cam√©ra
        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            modal.style.display = 'none';
        }

        // Prendre une photo
        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            // D√©finir les dimensions du canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Dessiner l'image du video sur le canvas
            ctx.drawImage(video, 0, 0);
            
            // Convertir en base64 avec compression
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Ajouter la photo √† la liste
            const photoObj = {
                id: Date.now() + Math.random(),
                data: imageData,
                timestamp: new Date().toISOString()
            };
            
            currentPhotos.push(photoObj);
            updatePhotoPreview();
            closeCamera();
            
            showMessage('success', `Photo ${currentPhotos.length}/${MAX_PHOTOS} ajout√©e avec succ√®s`);
        }

        // Mettre √† jour l'aper√ßu des photos
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            const counter = document.getElementById('photoCount');
            const cameraBtn = document.getElementById('cameraBtn');
            
            // Mettre √† jour le compteur
            counter.textContent = `${currentPhotos.length}/${MAX_PHOTOS} photos`;
            
            // D√©sactiver le bouton si limite atteinte
            if (currentPhotos.length >= MAX_PHOTOS) {
                cameraBtn.disabled = true;
                cameraBtn.textContent = 'üì± Limite atteinte (5/5)';
                cameraBtn.style.opacity = '0.6';
            } else {
                cameraBtn.disabled = false;
                cameraBtn.textContent = 'üì± Prendre une photo';
                cameraBtn.style.opacity = '1';
            }
            
            // Afficher les photos
            preview.innerHTML = currentPhotos.map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="Photo ${index + 1}" onclick="viewPhoto('${photo.data}')">
                    <button class="photo-delete" onclick="deletePhoto('${photo.id}')" title="Supprimer cette photo">√ó</button>
                </div>
            `).join('');
        }

        // Supprimer une photo
        function deletePhoto(photoId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?')) {
                currentPhotos = currentPhotos.filter(photo => photo.id !== photoId);
                updatePhotoPreview();
                showMessage('success', 'Photo supprim√©e');
            }
        }

        // Visualiser une photo en grand
        function viewPhoto(imageData) {
            const modal = document.createElement('div');
            modal.className = 'photo-viewer-modal';
            modal.innerHTML = `
                <div class="photo-viewer-content">
                    <button class="photo-viewer-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    <img src="${imageData}" alt="Photo agrandie" class="photo-viewer-image">
                </div>
            `;
            
            // Fermer au clic sur le fond
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // R√©initialiser les photos
        function resetPhotos() {
            currentPhotos = [];
            updatePhotoPreview();
        }

        // === FONCTIONS PDF AM√âLIOR√âES ===

        // Filtrer les contr√¥les pour l'export PDF
        async function filterControlsForPDF() {
            const dateDebut = document.getElementById('pdfDateDebut').value;
            const dateFin = document.getElementById('pdfDateFin').value;
            const resultsDiv = document.getElementById('pdfResults');
            const listDiv = document.getElementById('pdfControlsList');
            const generateAllBtn = document.getElementById('generateAllBtn');
            const statusDiv = document.getElementById('pdfStatus');

            try {
                statusDiv.innerHTML = '<div class="info-message">Recherche des contr√¥les...</div>';
                
                const allControls = await getAllControls();
                
                // Filtrer par dates si sp√©cifi√©es
                let filtered = allControls;
                
                if (dateDebut) {
                    filtered = filtered.filter(control => control.dateControle >= dateDebut);
                }
                
                if (dateFin) {
                    filtered = filtered.filter(control => control.dateControle <= dateFin);
                }
                
                // Trier par date d√©croissante
                filtered.sort((a, b) => new Date(b.dateControle) - new Date(a.dateControle));
                
                filteredControlsForPDF = filtered;
                
                if (filtered.length === 0) {
                    statusDiv.innerHTML = '<div class="warning-message">Aucun contr√¥le trouv√© pour cette p√©riode</div>';
                    resultsDiv.style.display = 'none';
                    generateAllBtn.disabled = true;
                    return;
                }
                
                // Afficher les r√©sultats
                listDiv.innerHTML = filtered.map(control => `
                    <div class="pdf-control-item">
                        <div class="pdf-control-info">
                            <strong>${control.immatriculation} - ${control.conducteur}</strong><br>
                            <small>Date: ${new Date(control.dateControle).toLocaleDateString('fr-FR')}</small>
                            ${control.photos && control.photos.length > 0 ? ` - ${control.photos.length} photo(s)` : ''}
                        </div>
                        <div class="pdf-control-actions">
                            <button class="btn btn-info" onclick="generateSinglePDF(${control.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                üìÑ G√©n√©rer PDF
                            </button>
                        </div>
                    </div>
                `).join('');
                
                resultsDiv.style.display = 'block';
                generateAllBtn.disabled = false;
                statusDiv.innerHTML = `<div class="success-message">${filtered.length} contr√¥le(s) trouv√©(s)</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-message">Erreur lors de la recherche: ${error.message}</div>`;
            }
        }

        // G√©n√©rer un PDF pour un contr√¥le sp√©cifique
        async function generateSinglePDF(controlId) {
            const loadingEl = document.getElementById('pdfLoading');
            const statusEl = document.getElementById('pdfStatus');
            
            try {
                loadingEl.style.display = 'block';
                
                // R√©cup√©rer le contr√¥le
                const controls = await getAllControls();
                const control = controls.find(c => c.id === controlId);
                
                if (!control) {
                    throw new Error('Contr√¥le introuvable');
                }
                
                await createImprovedPDFDocument(control);
                
                statusEl.innerHTML = '<div class="success-message">PDF g√©n√©r√© avec succ√®s!</div>';
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur lors de la g√©n√©ration: ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // G√©n√©rer tous les PDFs des contr√¥les filtr√©s
        async function generateAllPDFs() {
            if (filteredControlsForPDF.length === 0) {
                showMessage('warning', 'Aucun contr√¥le s√©lectionn√©');
                return;
            }

            const loadingEl = document.getElementById('pdfLoading');
            const statusEl = document.getElementById('pdfStatus');
            
            try {
                loadingEl.style.display = 'block';
                statusEl.innerHTML = '<div class="info-message">G√©n√©ration en cours...</div>';
                
                for (let i = 0; i < filteredControlsForPDF.length; i++) {
                    const control = filteredControlsForPDF[i];
                    statusEl.innerHTML = `<div class="info-message">G√©n√©ration du PDF ${i + 1}/${filteredControlsForPDF.length}: ${control.immatriculation}</div>`;
                    
                    await createImprovedPDFDocument(control);
                    
                    // Petite pause pour ne pas surcharger le navigateur
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ ${filteredControlsForPDF.length} PDF(s) g√©n√©r√©s avec succ√®s!</div>`;
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur lors de la g√©n√©ration: ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Cr√©er le document PDF am√©lior√© (format paysage avec photos optimis√©es)
        async function createImprovedPDFDocument(control) {
            const { jsPDF } = window.jspdf;
            
            // Cr√©er le contenu HTML pour le PDF
            const pdfContent = createImprovedPDFContent(control);
            
            // Cr√©er un conteneur temporaire pour le rendu
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '0';
            tempDiv.style.width = '297mm'; // A4 paysage width
            tempDiv.style.backgroundColor = 'white';
            tempDiv.innerHTML = pdfContent;
            document.body.appendChild(tempDiv);
            
            try {
                // G√©n√©rer le PDF avec html2canvas en haute qualit√©
                const canvas = await html2canvas(tempDiv, {
                    scale: 2, // Haute qualit√©
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: tempDiv.scrollWidth,
                    height: tempDiv.scrollHeight,
                    x: 0,
                    y: 0
                });
                
                // Cr√©er le PDF en format paysage (landscape)
                const pdf = new jsPDF('l', 'mm', 'a4'); // 'l' = landscape
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 297; // A4 paysage width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Ajouter l'image au PDF
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                // Si le contenu est trop haut, ajouter des pages
                if (imgHeight > 210) { // A4 paysage height
                    let position = -210;
                    while (position + imgHeight > 0) {
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        position -= 210;
                    }
                }
                
                // T√©l√©charger le PDF
                const fileName = `Controle_${control.immatriculation}_${control.dateControle}.pdf`;
                pdf.save(fileName);
                
            } finally {
                // Nettoyer
                document.body.removeChild(tempDiv);
            }
        }

        // Cr√©er le contenu HTML am√©lior√© pour le PDF
        function createImprovedPDFContent(control) {
            const formatDate = (dateStr) => {
                if (!dateStr) return 'Non renseign√©';
                return new Date(dateStr).toLocaleDateString('fr-FR');
            };
            
            const formatKilometrage = (km) => {
                if (!km) return 'N/A';
                return km + ' km';
            };
            
            const getStatusText = (value, type = 'boolean') => {
                if (type === 'boolean') {
                    return value ? '‚úì Pr√©sent' : '‚úó Absent';
                } else {
                    return value.charAt(0).toUpperCase() + value.slice(1);
                }
            };

            const getStatusClass = (value, type = 'boolean') => {
                if (type === 'boolean') {
                    return value ? 'pdf-status status-ok' : 'pdf-status status-missing';
                } else {
                    return `pdf-status status-${value}`;
                }
            };

            // Section commentaires
            const commentairesSection = control.commentaires && control.commentaires.trim() ? `
                <div class="pdf-section pdf-comments-section">
                    <div class="pdf-section-title">üí¨ Commentaires et observations</div>
                    <div class="pdf-comments-content">${control.commentaires}</div>
                </div>
            ` : '';

            // Section photos am√©lior√©e avec grille 3x2
            const photosSection = control.photos && control.photos.length > 0 ? `
                <div class="pdf-photos-section">
                    <div class="pdf-photos-title">üì∏ Photos du contr√¥le (${control.photos.length})</div>
                    <div class="pdf-photos-grid">
                        ${control.photos.slice(0, 6).map((photo, index) => `
                            <div class="pdf-photo-container">
                                <img src="${photo.data}" alt="Photo ${index + 1}" class="pdf-photo">
                                <div class="pdf-photo-caption">Photo ${index + 1} - ${new Date(photo.timestamp).toLocaleString('fr-FR')}</div>
                            </div>
                        `).join('')}
                    </div>
                    ${control.photos.length > 6 ? `<p style="margin-top: 15px; text-align: center; font-style: italic; color: #6c757d;">+ ${control.photos.length - 6} photo(s) suppl√©mentaire(s) disponibles</p>` : ''}
                </div>
            ` : '';
            
            return `
                <div class="pdf-page">
                    <div class="pdf-document-header">
                        <div class="pdf-company-logo">üöó GAZ SERVICE</div>
                        <div class="pdf-document-title">RAPPORT DE CONTR√îLE V√âHICULE</div>
                        <div class="pdf-subtitle">Contr√¥le et maintenance des v√©hicules de service</div>
                    </div>
                    
                    <div class="pdf-vehicle-info">
                        <div class="pdf-vehicle-title">V√©hicule ${control.immatriculation} - ${control.conducteur}</div>
                        <div class="pdf-control-date">Contr√¥le effectu√© le ${formatDate(control.dateControle)}</div>
                    </div>
                    
                    <div class="pdf-info-grid">
                        <div class="pdf-info-item">
                            <div class="pdf-info-label">Kilom√©trage</div>
                            <div class="pdf-info-value">${formatKilometrage(control.kilometrage)}</div>
                        </div>
                        <div class="pdf-info-item">
                            <div class="pdf-info-label">Prochain CT</div>
                            <div class="pdf-info-value">${formatDate(control.prochainControle)}</div>
                        </div>
                        <div class="pdf-info-item">
                            <div class="pdf-info-label">Derni√®re r√©vision</div>
                            <div class="pdf-info-value">${formatKilometrage(control.derniereRevision)}</div>
                        </div>
                        <div class="pdf-info-item">
                            <div class="pdf-info-label">Date de cr√©ation</div>
                            <div class="pdf-info-value">${formatDate(control.dateCreation)}</div>
                        </div>
                    </div>
                    
                    <div class="pdf-sections-container">
                        <div class="pdf-section">
                            <div class="pdf-section-title">üìã Documents obligatoires</div>
                            <div class="pdf-items-grid">
                                <div class="pdf-item">
                                    <span class="pdf-label">Permis de conduire</span>
                                    <span class="${getStatusClass(control.permis)}">${getStatusText(control.permis)}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Carte verte</span>
                                    <span class="${getStatusClass(control.carteVerte)}">${getStatusText(control.carteVerte)}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Carte grise</span>
                                    <span class="${getStatusClass(control.carteGrise)}">${getStatusText(control.carteGrise)}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Carte carburant</span>
                                    <span class="${getStatusClass(control.carteCarburant)}">${getStatusText(control.carteCarburant)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pdf-section">
                            <div class="pdf-section-title">üõ°Ô∏è √âquipements de s√©curit√©</div>
                            <div class="pdf-items-grid">
                                <div class="pdf-item">
                                    <span class="pdf-label">Gilet jaune</span>
                                    <span class="${getStatusClass(control.giletJaune)}">${getStatusText(control.giletJaune)}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Triangle</span>
                                    <span class="${getStatusClass(control.triangle)}">${getStatusText(control.triangle)}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Roue de secours</span>
                                    <span class="${getStatusClass(control.roueSecours)}">${getStatusText(control.roueSecours)}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Trousse de secours</span>
                                    <span class="${getStatusClass(control.trousseSecours)}">${getStatusText(control.trousseSecours)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pdf-section">
                            <div class="pdf-section-title">üîß √âtat g√©n√©ral</div>
                            <div class="pdf-items-grid">
                                <div class="pdf-item">
                                    <span class="pdf-label">Rangement</span>
                                    <span class="${getStatusClass(control.etatRangement, 'state')}">${getStatusText(control.etatRangement, 'state')}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Propret√© int.</span>
                                    <span class="${getStatusClass(control.propret√©Interieur, 'state')}">${getStatusText(control.propret√©Interieur, 'state')}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Propret√© ext.</span>
                                    <span class="${getStatusClass(control.propret√©Exterieur, 'state')}">${getStatusText(control.propret√©Exterieur, 'state')}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pdf-section">
                            <div class="pdf-section-title">üõû √âtat des pneus</div>
                            <div class="pdf-items-grid">
                                <div class="pdf-item">
                                    <span class="pdf-label">Avant gauche</span>
                                    <span class="${getStatusClass(control.pneuAvantGauche, 'state')}">${getStatusText(control.pneuAvantGauche, 'state')}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Avant droit</span>
                                    <span class="${getStatusClass(control.pneuAvantDroit, 'state')}">${getStatusText(control.pneuAvantDroit, 'state')}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Arri√®re gauche</span>
                                    <span class="${getStatusClass(control.pneuArriereGauche, 'state')}">${getStatusText(control.pneuArriereGauche, 'state')}</span>
                                </div>
                                <div class="pdf-item">
                                    <span class="pdf-label">Arri√®re droit</span>
                                    <span class="${getStatusClass(control.pneuArriereDroit, 'state')}">${getStatusText(control.pneuArriereDroit, 'state')}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${commentairesSection}
                    </div>
                    
                    ${photosSection}
                    
                    <div class="pdf-footer">
                        Rapport g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')} | 
                        Gaz Service - Syst√®me de suivi des v√©hicules | 
                        Page 1
                    </div>
                </div>
            `;
        }

        // === FONCTIONS DE SAUVEGARDE ===

        // Cr√©er une sauvegarde automatique (silencieuse)
        async function createAutoBackup() {
            try {
                const controls = await getAllControls();
                const vehicles = await getVehicleList();
                
                const backupData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    type: 'auto',
                    data: {
                        controls: controls,
                        vehicles: vehicles
                    }
                };
                
                // Stocker en localStorage comme sauvegarde de secours
                localStorage.setItem('gazservice_auto_backup', JSON.stringify(backupData));
                
            } catch (error) {
                console.error('Erreur lors de la sauvegarde automatique:', error);
            }
        }

        // T√©l√©charger la sauvegarde automatique
        function downloadAutoBackup() {
            const statusEl = document.getElementById('autoBackupStatus');
            
            try {
                const backupData = localStorage.getItem('gazservice_auto_backup');
                
                if (!backupData) {
                    statusEl.innerHTML = '<div class="error-message">Aucune sauvegarde automatique disponible</div>';
                    return;
                }
                
                const data = JSON.parse(backupData);
                const filename = `GazService_AutoBackup_${new Date().toISOString().split('T')[0]}.json`;
                
                downloadJSON(data, filename);
                statusEl.innerHTML = '<div class="success-message">Sauvegarde automatique t√©l√©charg√©e avec succ√®s</div>';
                
            } catch (error) {
                statusEl.innerHTML = '<div class="error-message">Erreur lors du t√©l√©chargement : ' + error.message + '</div>';
            }
        }

        // Cr√©er une sauvegarde manuelle
        async function createManualBackup() {
            const statusEl = document.getElementById('manualBackupStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Cr√©ation de la sauvegarde en cours...</div>';
                
                const controls = await getAllControls();
                const vehicles = await getVehicleList();
                
                const backupData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    type: 'manual',
                    data: {
                        controls: controls,
                        vehicles: vehicles
                    },
                    stats: {
                        totalControls: controls.length,
                        totalVehicles: vehicles.length,
                        dateRange: controls.length > 0 ? {
                            earliest: Math.min(...controls.map(c => new Date(c.dateControle).getTime())),
                            latest: Math.max(...controls.map(c => new Date(c.dateControle).getTime()))
                        } : null
                    }
                };
                
                const filename = `GazService_Backup_${new Date().toISOString().replace(/[:.]/g, '-').split('T')[0]}.json`;
                
                downloadJSON(backupData, filename);
                statusEl.innerHTML = `<div class="success-message">Sauvegarde cr√©√©e et t√©l√©charg√©e : ${filename}</div>`;
                
            } catch (error) {
                statusEl.innerHTML = '<div class="error-message">Erreur lors de la cr√©ation de la sauvegarde : ' + error.message + '</div>';
            }
        }

        // T√©l√©charger un objet JSON
        function downloadJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // G√©rer la s√©lection du fichier de sauvegarde
        function handleBackupFile(input) {
            const restoreBtn = document.getElementById('restoreBtn');
            const statusEl = document.getElementById('restoreStatus');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                    statusEl.innerHTML = '<div class="error-message">Veuillez s√©lectionner un fichier JSON valide</div>';
                    restoreBtn.disabled = true;
                    return;
                }
                
                selectedBackupFile = file;
                restoreBtn.disabled = false;
                statusEl.innerHTML = `<div class="info-message">Fichier s√©lectionn√© : ${file.name}</div>`;
            } else {
                selectedBackupFile = null;
                restoreBtn.disabled = true;
                statusEl.innerHTML = '';
            }
        }

        // Restaurer une sauvegarde
        async function restoreBackup() {
            if (!selectedBackupFile) {
                return;
            }
            
            const statusEl = document.getElementById('restoreStatus');
            
            if (!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nCette action va SUPPRIMER toutes les donn√©es actuelles et les remplacer par celles du fichier de sauvegarde.\n\n√ätes-vous s√ªr de vouloir continuer ?')) {
                return;
            }
            
            try {
                statusEl.innerHTML = '<div class="info-message">Restauration en cours...</div>';
                
                // Lire le fichier
                const fileContent = await readFileAsText(selectedBackupFile);
                const backupData = JSON.parse(fileContent);
                
                // V√©rifier la structure du fichier
                if (backupData.version === '2.0' && backupData.data) {
                    // Nouvelle structure avec v√©hicules et contr√¥les s√©par√©s
                    const controls = backupData.data.controls || [];
                    const vehicles = backupData.data.vehicles || [];
                    
                    // Vider les bases actuelles
                    await clearAllData();
                    await clearVehicleListFromDB();
                    
                    // Restaurer les contr√¥les
                    for (const control of controls) {
                        const { id, ...controlData } = control;
                        await saveControlDirectly(controlData);
                    }
                    
                    // Restaurer les v√©hicules
                    if (vehicles.length > 0) {
                        await saveVehicleList(vehicles);
                    }
                    
                    statusEl.innerHTML = `<div class="success-message">
                        ‚úÖ Restauration r√©ussie !<br>
                        ${controls.length} contr√¥le(s) restaur√©(s)<br>
                        ${vehicles.length} v√©hicule(s) restaur√©(s)<br>
                        Date de la sauvegarde : ${new Date(backupData.timestamp).toLocaleString('fr-FR')}
                    </div>`;
                    
                } else if (backupData.data && Array.isArray(backupData.data)) {
                    // Ancienne structure (r√©trocompatibilit√©)
                    await clearAllData();
                    
                    for (const control of backupData.data) {
                        const { id, ...controlData } = control;
                        await saveControlDirectly(controlData);
                    }
                    
                    statusEl.innerHTML = `<div class="success-message">
                        ‚úÖ Restauration r√©ussie !<br>
                        ${backupData.data.length} contr√¥le(s) restaur√©(s)<br>
                        Date de la sauvegarde : ${new Date(backupData.timestamp).toLocaleString('fr-FR')}
                    </div>`;
                } else {
                    throw new Error('Format de fichier de sauvegarde invalide');
                }
                
                // Recharger l'affichage
                await loadControls();
                await loadVehicleProgress();
                
                // R√©initialiser la s√©lection
                document.getElementById('backupFile').value = '';
                document.getElementById('restoreBtn').disabled = true;
                selectedBackupFile = null;
                
                // Cr√©er une nouvelle sauvegarde automatique
                createAutoBackup();
                
            } catch (error) {
                statusEl.innerHTML = '<div class="error-message">Erreur lors de la restauration : ' + error.message + '</div>';
            }
        }

        // Lire un fichier comme texte
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsText(file);
            });
        }

        // Sauvegarder un contr√¥le sans d√©clencher la sauvegarde automatique
        function saveControlDirectly(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // === FONCTIONS EXISTANTES ===

        // Gestion des onglets
        function showTab(tabName) {
            // Masquer tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activer l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Charger les donn√©es si n√©cessaire
            if (tabName === 'historique') {
                loadControls();
            } else if (tabName === 'avancement') {
                loadVehicleProgress();
            } else if (tabName === 'pdf') {
                // Initialiser les dates par d√©faut pour le PDF
                const today = new Date().toISOString().split('T')[0];
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                const lastMonthStr = lastMonth.toISOString().split('T')[0];
                
                if (!document.getElementById('pdfDateDebut').value) {
                    document.getElementById('pdfDateDebut').value = lastMonthStr;
                }
                if (!document.getElementById('pdfDateFin').value) {
                    document.getElementById('pdfDateFin').value = today;
                }
            }
        }

        // Gestion du formulaire
        document.getElementById('vehicleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                conducteur: formData.get('conducteur'),
                dateControle: formData.get('dateControle'),
                immatriculation: formData.get('immatriculation').toUpperCase(),
                kilometrage: formData.get('kilometrage') || null,
                prochainControle: formData.get('prochainControle') || null,
                derniereRevision: formData.get('derniereRevision') || null,
                
                // Documents
                permis: formData.has('permis'),
                carteVerte: formData.has('carteVerte'),
                carteGrise: formData.has('carteGrise'),
                carteCarburant: formData.has('carteCarburant'),
                
                // √âquipements
                giletJaune: formData.has('giletJaune'),
                triangle: formData.has('triangle'),
                roueSecours: formData.has('roueSecours'),
                trousseSecours: formData.has('trousseSecours'),
                
                // √âtats
                etatRangement: formData.get('etatRangement'),
                propret√©Interieur: formData.get('propret√©Interieur'),
                propret√©Exterieur: formData.get('propret√©Exterieur'),
                
                // Pneus
                pneuAvantGauche: formData.get('pneuAvantGauche'),
                pneuAvantDroit: formData.get('pneuAvantDroit'),
                pneuArriereGauche: formData.get('pneuArriereGauche'),
                pneuArriereDroit: formData.get('pneuArriereDroit'),
                
                // Commentaires
                commentaires: formData.get('commentaires') || '',
                
                // Photos
                photos: currentPhotos.map(photo => ({
                    id: photo.id,
                    data: photo.data,
                    timestamp: photo.timestamp
                })),
                
                dateCreation: new Date().toISOString()
            };
            
            try {
                await saveControl(data);
                showMessage('success', `Contr√¥le enregistr√© avec succ√®s ! (${currentPhotos.length} photo(s) incluse(s))`);
                resetForm();
                loadControls();
            } catch (error) {
                showMessage('error', 'Erreur lors de l\'enregistrement : ' + error.message);
            }
        });

        // R√©initialiser le formulaire
        function resetForm() {
            document.getElementById('vehicleForm').reset();
            document.getElementById('dateControle').value = new Date().toISOString().split('T')[0];
            updateCheckboxStyles();
            resetPhotos(); // R√©initialiser aussi les photos
        }

        // Charger et afficher les contr√¥les
        async function loadControls() {
            try {
                const controls = await getAllControls();
                displayControls(controls);
            } catch (error) {
                console.error('Erreur lors du chargement des contr√¥les:', error);
            }
        }

        // Afficher les contr√¥les
        function displayControls(controls) {
            const container = document.getElementById('controlsList');
            
            if (controls.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Aucun contr√¥le enregistr√©</h3>
                        <p>Commencez par ajouter un nouveau contr√¥le</p>
                    </div>
                `;
                return;
            }
            
            controls.sort((a, b) => new Date(b.dateControle) - new Date(a.dateControle));
            
            container.innerHTML = controls.map(control => createControlCard(control)).join('');
        }

        // Cr√©er une carte de contr√¥le
        function createControlCard(control) {
            const formatDate = (dateStr) => {
                if (!dateStr) return 'Non renseign√©';
                return new Date(dateStr).toLocaleDateString('fr-FR');
            };
            
            const formatKilometrage = (km) => {
                if (!km) return 'Non renseign√©';
                return km + ' km';
            };
            
            const getStatusBadge = (value, type = 'boolean') => {
                if (type === 'boolean') {
                    return value ? 
                        '<span class="status-badge status-ok">‚úì Pr√©sent</span>' :
                        '<span class="status-badge status-missing">‚úó Absent</span>';
                } else {
                    return `<span class="status-badge status-${value}">${value.charAt(0).toUpperCase() + value.slice(1)}</span>`;
                }
            };

            // G√©n√©rer la section commentaires
            const commentairesSection = control.commentaires && control.commentaires.trim() ? `
                <div class="control-comments">
                    <h5>üí¨ Commentaires</h5>
                    <div class="comment-text" style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #007bff; margin-top: 10px; white-space: pre-wrap;">${control.commentaires}</div>
                </div>
            ` : '';

            // G√©n√©rer la section photos
            const photosSection = control.photos && control.photos.length > 0 ? `
                <div class="control-photos">
                    <h5>üì∏ Photos du contr√¥le (${control.photos.length})</h5>
                    <div class="photos-grid">
                        ${control.photos.map((photo, index) => `
                            <img src="${photo.data}" 
                                 alt="Photo ${index + 1}" 
                                 class="photo-thumbnail" 
                                 onclick="viewPhoto('${photo.data}')"
                                 title="Cliquez pour agrandir">
                        `).join('')}
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="control-item">
                    <div class="control-header">
                        <h4>üöó ${control.immatriculation} - ${control.conducteur}</h4>
                        <button class="btn btn-danger" onclick="deleteControlById(${control.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                    
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Date du contr√¥le</span>
                            <span class="info-value">${formatDate(control.dateControle)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Kilom√©trage</span>
                            <span class="info-value">${formatKilometrage(control.kilometrage)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Prochain CT</span>
                            <span class="info-value">${formatDate(control.prochainControle)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Derni√®re r√©vision</span>
                            <span class="info-value">${formatKilometrage(control.derniereRevision)}</span>
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üìã Documents</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Permis</span>
                            ${getStatusBadge(control.permis)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte verte</span>
                            ${getStatusBadge(control.carteVerte)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte grise</span>
                            ${getStatusBadge(control.carteGrise)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte carburant</span>
                            ${getStatusBadge(control.carteCarburant)}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üõ°Ô∏è √âquipements</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Gilet jaune</span>
                            ${getStatusBadge(control.giletJaune)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Triangle</span>
                            ${getStatusBadge(control.triangle)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Roue secours</span>
                            ${getStatusBadge(control.roueSecours)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Trousse secours</span>
                            ${getStatusBadge(control.trousseSecours)}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üîß √âtat g√©n√©ral</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Rangement</span>
                            ${getStatusBadge(control.etatRangement, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Propret√© int.</span>
                            ${getStatusBadge(control.propret√©Interieur, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Propret√© ext.</span>
                            ${getStatusBadge(control.propret√©Exterieur, 'state')}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üõû Pneus</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Avant gauche</span>
                            ${getStatusBadge(control.pneuAvantGauche, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Avant droit</span>
                            ${getStatusBadge(control.pneuAvantDroit, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Arri√®re gauche</span>
                            ${getStatusBadge(control.pneuArriereGauche, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Arri√®re droit</span>
                            ${getStatusBadge(control.pneuArriereDroit, 'state')}
                        </div>
                    </div>
                    
                    ${commentairesSection}
                    
                    ${photosSection}
                </div>
            `;
        }

        // Supprimer un contr√¥le
        async function deleteControlById(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce contr√¥le ?')) {
                try {
                    await deleteControl(id);
                    showMessage('success', '‚úÖ Contr√¥le supprim√© avec succ√®s !');
                    loadControls();
                } catch (error) {
                    showMessage('error', '‚ùå Erreur lors de la suppression : ' + error.message);
                }
            }
        }

        // Filtrer les contr√¥les
        function filterControls() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const controlItems = document.querySelectorAll('.control-item');
            
            controlItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Export Excel
        async function exportToExcel() {
            const loadingEl = document.getElementById('exportLoading');
            const statusEl = document.getElementById('exportStatus');
            
            try {
                loadingEl.style.display = 'block';
                statusEl.innerHTML = '';
                
                const controls = await getAllControls();
                
                if (controls.length === 0) {
                    throw new Error('Aucune donn√©e √† exporter');
                }
                
                // Pr√©parer les donn√©es pour Excel
                const excelData = controls.map(control => ({
                    'Date contr√¥le': control.dateControle,
                    'Conducteur': control.conducteur,
                    'Immatriculation': control.immatriculation,
                    'Kilom√©trage': control.kilometrage || '',
                    'Prochain CT': control.prochainControle || '',
                    'Derni√®re r√©vision (km)': control.derniereRevision || '',
                    'Permis': control.permis ? 'Oui' : 'Non',
                    'Carte verte': control.carteVerte ? 'Oui' : 'Non',
                    'Carte grise': control.carteGrise ? 'Oui' : 'Non',
                    'Carte carburant': control.carteCarburant ? 'Oui' : 'Non',
                    'Gilet jaune': control.giletJaune ? 'Oui' : 'Non',
                    'Triangle': control.triangle ? 'Oui' : 'Non',
                    'Roue secours': control.roueSecours ? 'Oui' : 'Non',
                    'Trousse secours': control.trousseSecours ? 'Oui' : 'Non',
                    '√âtat rangement': control.etatRangement,
                    'Propret√© int√©rieur': control.propret√©Interieur,
                    'Propret√© ext√©rieur': control.propret√©Exterieur,
                    'Pneu AV G': control.pneuAvantGauche,
                    'Pneu AV D': control.pneuAvantDroit,
                    'Pneu AR G': control.pneuArriereGauche,
                    'Pneu AR D': control.pneuArriereDroit,
                    'Commentaires': control.commentaires || '',
                    'Nb Photos': control.photos ? control.photos.length : 0,
                    'Date cr√©ation': new Date(control.dateCreation).toLocaleDateString('fr-FR')
                }));
                
                // Cr√©er le workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Ajuster la largeur des colonnes
                const colWidths = [];
                Object.keys(excelData[0]).forEach(key => {
                    const maxLength = Math.max(
                        key.length,
                        ...excelData.map(row => String(row[key] || '').length)
                    );
                    colWidths.push({ width: Math.min(maxLength + 2, 50) });
                });
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Contr√¥les V√©hicules');
                
                // G√©n√©rer et t√©l√©charger le fichier
                const fileName = `Controles_Vehicules_GazService_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ Fichier "${fileName}" t√©l√©charg√© avec succ√®s !</div>`;
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">‚ùå Erreur lors de l'export : ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Afficher un message
        function showMessage(type, message) {
            const messageEl = document.createElement('div');
            messageEl.className = `${type}-message`;
            messageEl.textContent = message;
            messageEl.style.position = 'fixed';
            messageEl.style.top = '20px';
            messageEl.style.right = '20px';
            messageEl.style.zIndex = '1000';
            messageEl.style.maxWidth = '400px';
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // Style des checkboxes
        function updateCheckboxStyles() {
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
        }

        // √âcouteurs d'√©v√©nements pour les checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                updateCheckboxStyles();
            }
        });

        // Formatage automatique de l'immatriculation
        function formatImmatriculation(value) {
            // Supprimer tous les caract√®res non alphanum√©riques
            value = value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
            
            // Limiter √† 7 caract√®res (2 lettres + 3 chiffres + 2 lettres)
            if (value.length > 7) {
                value = value.substring(0, 7);
            }
            
            // Formater avec des tirets : AA-000-AA
            if (value.length >= 5) {
                return value.substring(0, 2) + '-' + value.substring(2, 5) + '-' + value.substring(5);
            } else if (value.length >= 2) {
                return value.substring(0, 2) + '-' + value.substring(2);
            }
            
            return value;
        }

        // Valider le format de l'immatriculation
        function validateImmatriculation(value) {
            const regex = /^[A-Z]{2}-[0-9]{3}-[A-Z]{2}$/;
            return regex.test(value);
        }

        // Gestionnaire pour le champ immatriculation et nom du conducteur
        document.addEventListener('DOMContentLoaded', function() {
            const immatriculationField = document.getElementById('immatriculation');
            const conducteurField = document.getElementById('conducteur');
            
            // Formatage du champ immatriculation
            if (immatriculationField) {
                immatriculationField.addEventListener('input', function(e) {
                    const cursorPosition = e.target.selectionStart;
                    const oldValue = e.target.value;
                    const newValue = formatImmatriculation(e.target.value);
                    
                    e.target.value = newValue;
                    
                    // Repositionner le curseur
                    const newCursorPosition = cursorPosition + (newValue.length - oldValue.length);
                    e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                    
                    // Validation visuelle
                    if (newValue.length === 9 && validateImmatriculation(newValue)) {
                        e.target.style.borderColor = '#28a745';
                        e.target.style.backgroundColor = '#f8fff9';
                    } else if (newValue.length > 0) {
                        e.target.style.borderColor = '#ffc107';
                        e.target.style.backgroundColor = '#fffdf0';
                    } else {
                        e.target.style.borderColor = '#bdc3c7';
                        e.target.style.backgroundColor = '#ffffff';
                    }
                });

                // Validation au blur
                immatriculationField.addEventListener('blur', function(e) {
                    if (e.target.value && !validateImmatriculation(e.target.value)) {
                        e.target.style.borderColor = '#dc3545';
                        e.target.style.backgroundColor = '#fff5f5';
                        showMessage('warning', 'Format d\'immatriculation invalide. Utilisez le format AA-000-AA');
                    }
                });
            }

            // Formatage du champ nom du conducteur en majuscules
            if (conducteurField) {
                conducteurField.addEventListener('input', function(e) {
                    const cursorPosition = e.target.selectionStart;
                    const newValue = e.target.value.toUpperCase();
                    
                    e.target.value = newValue;
                    
                    // Maintenir la position du curseur
                    e.target.setSelectionRange(cursorPosition, cursorPosition);
                });
            }
        });

        // Drag & Drop pour l'import de fichiers
        document.addEventListener('DOMContentLoaded', function() {
            const importSection = document.getElementById('importSection');
            
            if (importSection) {
                // Gestion du drag & drop
                importSection.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    importSection.classList.add('drag-over');
                });
                
                importSection.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    importSection.classList.remove('drag-over');
                });
                
                importSection.addEventListener('drop', function(e) {
                    e.preventDefault();
                    importSection.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = document.getElementById('vehicleListFile');
                        fileInput.files = files;
                        handleVehicleListFile(fileInput);
                    }
                });
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initDB();
                console.log('Base de donn√©es initialis√©e avec succ√®s');
                
                // D√©finir la date du jour par d√©faut
                document.getElementById('dateControle').value = new Date().toISOString().split('T')[0];
                
                // Initialiser les photos
                updatePhotoPreview();
                
                // Charger les contr√¥les si on est sur l'onglet historique
                loadControls();
                
                // V√©rifier s'il y a une sauvegarde automatique existante
                const autoBackup = localStorage.getItem('gazservice_auto_backup');
                if (autoBackup) {
                    const backupData = JSON.parse(autoBackup);
                    const controlsCount = backupData.data ? 
                        (backupData.data.controls ? backupData.data.controls.length : backupData.data.length) : 0;
                    const vehiclesCount = backupData.data && backupData.data.vehicles ? backupData.data.vehicles.length : 0;
                    console.log(`Sauvegarde automatique disponible : ${controlsCount} contr√¥le(s), ${vehiclesCount} v√©hicule(s), cr√©√©e le ${new Date(backupData.timestamp).toLocaleString('fr-FR')}`);
                }
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation de la base de donn√©es:', error);
                showMessage('error', 'Erreur d\'initialisation de la base de donn√©es');
            }
        });

        // G√©rer la fermeture du modal cam√©ra avec Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const cameraModal = document.getElementById('cameraModal');
                if (cameraModal.style.display === 'flex') {
                    closeCamera();
                }
                
                // Fermer aussi le viewer de photos
                const photoViewer = document.querySelector('.photo-viewer-modal');
                if (photoViewer) {
                    photoViewer.remove();
                }
            }
        });

    </script>
</body>
</html>